name: Build luci-app-temp-status

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'OpenWrt SDK 下載地址 (.tar.zst)'
        required: true
        default: 'https://downloads.openwrt.org/releases/24.10.0/targets/rockchip/armv8/openwrt-sdk-24.10.0-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

env:
  PLUGIN_REPO: "https://github.com/gSpotx2f/luci-app-temp-status.git"
  PACKAGE_NAME: "luci-app-temp-status"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 初始化環境
        uses: actions/checkout@v4

      - name: 安裝編譯依賴與 OpenCC
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget zstd \
            ccache ecj fastjar libelf-dev xsltproc python3-pyelftools \
            opencc

      - name: 下載並解壓 SDK
        run: |
          SDK_URL="${{ inputs.sdk_url }}"
          SDK_FILE=$(basename "$SDK_URL")
          
          echo "正在下載 SDK: $SDK_FILE"
          wget -qO "$SDK_FILE" "$SDK_URL"
          
          echo "正在解壓 SDK..."
          mkdir sdk
          tar -I zstd -xf "$SDK_FILE" -C sdk --strip-components=1
          rm -f "$SDK_FILE"

      - name: 下載插件原始碼
        working-directory: ./sdk/package
        run: |
          git clone "$PLUGIN_REPO"

      - name: 標準化語言包並轉換繁體 (OpenCC)
        working-directory: ./sdk/package
        run: |
          # 尋找插件目錄
          PKG_DIR=$(find . -maxdepth 1 -type d -name "*temp-status*" | head -n 1)
          if [ -z "$PKG_DIR" ]; then echo "錯誤：找不到插件目錄"; exit 1; fi
          cd "$PKG_DIR"
          echo "正在處理目錄: $(pwd)"
          
          PO_DIR="po"
          SRC_HANS="$PO_DIR/zh_Hans"
          DEST_HANT="$PO_DIR/zh_Hant"
          LEGACY_CN="$PO_DIR/zh-cn"
          
          # --- 步驟 1: 標準化來源目錄 (zh-cn -> zh_Hans) ---
          if [ -d "$LEGACY_CN" ]; then
            if [ -d "$SRC_HANS" ]; then
              rm -rf "$LEGACY_CN"
            else
              mv "$LEGACY_CN" "$SRC_HANS"
              # 修正標頭
              sed -i "s/Language: zh_CN/Language: zh_Hans/g" "$SRC_HANS"/*.po 2>/dev/null || true
              sed -i "s/Language: zh-cn/Language: zh_Hans/g" "$SRC_HANS"/*.po 2>/dev/null || true
            fi
          fi

          # --- 步驟 2: 生成繁體中文 ---
          if [ -d "$DEST_HANT" ]; then
            echo "繁體中文已存在，跳過生成。"
          elif [ -d "$SRC_HANS" ]; then
            echo "正在生成繁體中文..."
            mkdir -p "$DEST_HANT"
            
            for file in "$SRC_HANS"/*.po; do
              [ -e "$file" ] || continue
              filename=$(basename "$file")
              
              # OpenCC 轉換 (簡體 -> 台灣繁體)
              opencc -c s2tw -i "$file" -o "$DEST_HANT/$filename"
              
              # 修正 po 檔標頭與詞彙
              sed -i "s/Language: zh_Hans/Language: zh_Hant/g" "$DEST_HANT/$filename"
              sed -i "s/Language: zh_CN/Language: zh_Hant/g" "$DEST_HANT/$filename"
              sed -i "s/Language: zh-cn/Language: zh_Hant/g" "$DEST_HANT/$filename"
              
              # 常見詞彙修正
              sed -i "s/配置文件/設定檔/g" "$DEST_HANT/$filename"
              sed -i "s/配置/設定/g" "$DEST_HANT/$filename"
              sed -i "s/保存/儲存/g" "$DEST_HANT/$filename"
              sed -i "s/應用/套用/g" "$DEST_HANT/$filename"
              sed -i "s/启用/啟用/g" "$DEST_HANT/$filename"
              sed -i "s/刷新/重新整理/g" "$DEST_HANT/$filename"
              sed -i "s/界面/介面/g" "$DEST_HANT/$filename"
              sed -i "s/插件/外掛/g" "$DEST_HANT/$filename"
            done
          else
            echo "警告：無簡體中文來源，無法轉換。"
          fi

      - name: 更新並安裝 Feeds
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置並編譯
        working-directory: ./sdk
        run: |
          make defconfig
          
          # --- 設定編譯選項 ---
          echo "CONFIG_PACKAGE_$PACKAGE_NAME=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-temp-status-zh-hans=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-temp-status-zh-hant=m" >> .config
          
          make defconfig
          
          echo "開始編譯 $PACKAGE_NAME ..."
          make package/$PACKAGE_NAME/compile V=s -j$(nproc) || make package/$PACKAGE_NAME/compile V=s -j1

      - name: 整理並重新命名安裝包 (區分 ipk/apk 規則)
        run: |
          mkdir -p output
          find sdk/bin -type f -name "*temp-status*" \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} output/ \;
          
          if [ -z "$(ls -A output)" ]; then
             echo "錯誤：未找到編譯出的文件！"
             exit 1
          fi

          echo "--- 開始執行重命名 ---"
          cd output
          for file in *; do
            [ -f "$file" ] || continue
            
            # 僅針對 i18n 語言包重命名
            if [[ "$file" == *"i18n"* ]]; then
                ext="${file##*.}"
                new_file=""

                if [[ "$ext" == "ipk" ]]; then
                    # --- IPK 規則: Name_Version_Arch.ipk -> Name_0_Arch.ipk ---
                    
                    # 1. 取得主檔名 (luci-i18n..._all)
                    base="${file%.*}"
                    
                    # 2. 提取架構 (最後一個底線後的字串: all)
                    arch="${base##*_}"
                    
                    # 3. 提取 "名稱_版本" (去掉 _架構)
                    name_ver="${base%_*}"
                    
                    # 4. 提取 "名稱" (去掉 _版本 -> 去掉最後一個底線後的字串)
                    # 假設 Name 不含底線，或者版本號在最後一段
                    name="${name_ver%_*}"
                    
                    new_file="${name}_0_${arch}.${ext}"

                elif [[ "$ext" == "apk" ]]; then
                    # --- APK 規則: Name-Version.apk -> Name-0.apk ---
                    
                    # 1. 提取名稱 (找到第一個 "-數字" 出現的位置並切除後面)
                    name=$(echo "$file" | sed -E 's/-[0-9].*//')
                    
                    new_file="${name}-0.${ext}"
                fi

                # 執行重命名
                if [[ -n "$new_file" && "$file" != "$new_file" ]]; then
                    echo "重命名 [$ext]: $file -> $new_file"
                    mv "$file" "$new_file"
                fi
            else
                echo "保留主程式原名: $file"
            fi
          done
          
          echo "--- 最終輸出目錄內容 ---"
          ls -lh

      - name: 設定成品名稱
        id: set_name
        run: |
          SDK_URL="${{ inputs.sdk_url }}"
          if [[ "$SDK_URL" == *"snapshots"* ]]; then
            OP_VERSION="SNAPSHOT"
          elif [[ "$SDK_URL" == *"releases"* ]]; then
            OP_VERSION=$(echo "$SDK_URL" | grep -oP 'releases/\K[0-9.]+(?=/targets)')
          else
            OP_VERSION="Custom"
          fi
          echo "ARTIFACT_SUFFIX=$OP_VERSION" >> $GITHUB_ENV

      - name: 上傳成品
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ env.ARTIFACT_SUFFIX }}
          path: output/*
