name: Build luci-i18n-temp-status-zh-tw

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'OpenWrt SDK URL (Optional, defaults to env)'
        required: false
        default: 'https://downloads.openwrt.org/releases/24.10.5/targets/rockchip/armv8/openwrt-sdk-24.10.5-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # 預設 SDK (可在此更換)
      DEFAULT_SDK_URL: https://downloads.openwrt.org/releases/24.10.5/targets/rockchip/armv8/openwrt-sdk-24.10.5-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
      PKG_URL: https://github.com/gSpotx2f/luci-app-temp-status.git

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 包含 python3-pyelftools 修復 u-boot 錯誤，zstd 修復新版解壓
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 file opencc zstd python3-pyelftools python3-setuptools

      - name: Download and Setup SDK
        run: |
          SDK_LINK="${{ github.event.inputs.sdk_url }}"
          if [ -z "$SDK_LINK" ]; then
            SDK_LINK="$DEFAULT_SDK_URL"
          fi
          
          echo "Downloading SDK from: $SDK_LINK"
          wget "$SDK_LINK"
          
          SDK_FILE=$(basename "$SDK_LINK")
          mkdir sdk
          
          # === 版本號提取邏輯 ===
          # 嘗試匹配類似 23.05.5 的版本號
          if [[ "$SDK_FILE" =~ openwrt-sdk-([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VER="${BASH_REMATCH[1]}"
          else
            # 如果匹配不到數字版本，通常是 snapshot 或其他命名
            VER="snapshot"
          fi
          
          echo "Detected Version: $VER"
          echo "OPENWRT_VERSION=$VER" >> $GITHUB_ENV
          # ======================
          
          # 解壓判斷
          if [[ "$SDK_FILE" == *".zst" ]]; then
            echo "Detected ZSTD archive..."
            tar -I zstd -xf "$SDK_FILE" -C sdk --strip-components=1
          else
            echo "Detected XZ/GZIP archive..."
            tar -xf "$SDK_FILE" -C sdk --strip-components=1
          fi
          
          cd sdk
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a -p luci || true
          ./scripts/feeds install -a || true

      - name: Prepare Languages (Hans & Hant)
        working-directory: ./sdk/package
        run: |
          git clone $PKG_URL luci-app-temp-status
          cd luci-app-temp-status/po
          
          echo "=== 步驟 1: 處理簡體中文 (Base) ==="
          if [ -d "zh-cn" ]; then
            mv zh-cn zh_Hans
            sed -i 's/Language: zh_CN/Language: zh_Hans/g' zh_Hans/*.po
            sed -i 's/"Language-Team: zh_CN/"Language-Team: zh_Hans/g' zh_Hans/*.po
          fi
          
          echo "=== 步驟 2: 建立繁體中文 (New) ==="
          if [ -d "zh_Hans" ]; then
            cp -r zh_Hans zh_Hant
            
            for file in zh_Hant/*.po; do
              opencc -c s2tw.json -i "$file" -o "$file.tmp"
              mv "$file.tmp" "$file"
              sed -i 's/Language: zh_Hans/Language: zh_Hant/g' "$file"
              sed -i 's/Language: zh_CN/Language: zh_Hant/g' "$file"
              sed -i 's/"Language-Team: zh_Hans/"Language-Team: zh_Hant/g' "$file"
            done
          fi

      - name: Configure Build
        working-directory: ./sdk
        run: |
          make defconfig
          
          # 關閉 u-boot 以加速並避免錯誤
          sed -i 's/CONFIG_PACKAGE_uboot-rockchip.*=y/# CONFIG_PACKAGE_uboot-rockchip is not set/' .config
          sed -i 's/CONFIG_PACKAGE_uboot-rockchip.*=m/# CONFIG_PACKAGE_uboot-rockchip is not set/' .config

          # 設定插件
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hant=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-temp-status=m" >> .config
          
          make defconfig
          
          # 暴力開啟語言包
          sed -i 's/# CONFIG_PACKAGE_luci-i18n-temp-status-\(.*\) is not set/CONFIG_PACKAGE_luci-i18n-temp-status-\1=m/g' .config
          
          make defconfig

      - name: Compile Package
        working-directory: ./sdk
        run: |
          echo "=== Start Compiling for OpenWrt ${{ env.OPENWRT_VERSION }} ==="
          make package/luci-app-temp-status/compile V=s -j$(nproc) || make package/luci-app-temp-status/compile V=s -j1

      - name: Organize Files
        run: |
          mkdir -p bin-output
          # 支援 ipk (舊版) 和 apk (新版)
          find sdk/bin/ -type f \( -name "luci-app-temp-status*.*pk" -o -name "luci-i18n-temp-status*.*pk" \) -exec cp {} bin-output/ \;
          ls -R bin-output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # 修改這裡：在名稱後加上版本號
          name: luci-app-temp-status-${{ env.OPENWRT_VERSION }}
          path: bin-output/
