name: Build luci-theme-aurora

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'OpenWrt SDK 下載地址 (.tar.zst)'
        required: true
        default: 'https://downloads.openwrt.org/releases/24.10.5/targets/rockchip/armv8/openwrt-sdk-24.10.5-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

env:
  PLUGIN_REPO: "https://github.com/eamonxg/luci-theme-aurora.git"
  PACKAGE_NAME: "luci-theme-aurora"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 初始化環境
        uses: actions/checkout@v4

      - name: 安裝編譯依賴
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget zstd \
            ccache ecj fastjar libelf-dev xsltproc python3-pyelftools

      - name: 下載並解壓 SDK
        run: |
          SDK_URL="${{ inputs.sdk_url }}"
          SDK_FILE=$(basename "$SDK_URL")
          wget -qO "$SDK_FILE" "$SDK_URL"
          mkdir sdk
          tar -I zstd -xf "$SDK_FILE" -C sdk --strip-components=1
          rm -f "$SDK_FILE"

      - name: 下載插件原始碼
        working-directory: ./sdk/package
        run: |
          git clone "$PLUGIN_REPO"

      - name: 更新並安裝 Feeds
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置並編譯
        working-directory: ./sdk
        run: |
          # 基礎配置
          make defconfig
          
          # 確保核心 Luci 依賴存在
          ./scripts/feeds install luci-base luci-compat || true
          
          # --- 設定編譯選項 ---
          echo "CONFIG_PACKAGE_$PACKAGE_NAME=m" >> .config
          
          # 針對 Aurora 主題的語言包處理 (如果有)
          echo "CONFIG_PACKAGE_luci-i18n-aurora-zh-cn=m" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-aurora-zh-tw=m" >> .config
          
          make defconfig
          echo "開始編譯 $PACKAGE_NAME ..."
          make package/$PACKAGE_NAME/compile V=s -j$(nproc)

      - name: 整理並重新命名安裝包 (版本號歸零)
        run: |
          mkdir -p output
          find sdk/bin -type f -name "*aurora*" \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} output/ \;
          
          if [ -z "$(ls -A output)" ]; then
             echo "錯誤：未找到編譯出的文件！"
             exit 1
          fi

          cd output
          for file in *; do
            [ -f "$file" ] || continue
            
            # 針對主題包與其語言包進行重命名
            ext="${file##*.}"
            filename_no_ext="${file%.*}"
            new_file=""

            if [[ "$ext" == "ipk" ]]; then
                # IPK: Name_Version_Arch.ipk -> Name_0_Arch.ipk
                arch="${filename_no_ext##*_}"
                name_ver="${filename_no_ext%_*}"
                name="${name_ver%_*}"
                new_file="${name}_0_${arch}.${ext}"
            elif [[ "$ext" == "apk" ]]; then
                # APK: Name-Version.apk -> Name-0.apk
                name="${filename_no_ext%-*}"
                new_file="${name}-0.${ext}"
            fi
            
            if [[ -n "$new_file" && "$file" != "$new_file" ]]; then
                echo "重命名: $file -> $new_file"
                mv "$file" "$new_file"
            fi
          done

      - name: 設定成品名稱
        id: set_name
        run: |
          SDK_URL="${{ inputs.sdk_url }}"
          if [[ "$SDK_URL" == *"snapshots"* ]]; then
            OP_VERSION="SNAPSHOT"
          elif [[ "$SDK_URL" == *"releases"* ]]; then
            OP_VERSION=$(echo "$SDK_URL" | grep -oP 'releases/\K[^/]+(?=/targets)')
          else
            OP_VERSION="Custom"
          fi
          echo "ARTIFACT_SUFFIX=$OP_VERSION" >> $GITHUB_ENV

      - name: 上傳成品
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ env.ARTIFACT_SUFFIX }}
          path: output/*
