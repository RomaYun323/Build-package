name: Build luci-i18n-temp-status-zh-tw

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'OpenWrt SDK URL'
        required: false
        default: 'https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEFAULT_SDK_URL: https://downloads.openwrt.org/releases/24.10.4/targets/rockchip/armv8/openwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst
      PKG_URL: https://github.com/eamonxg/luci-app-aurora-config.git
      PKG_NAME: luci-app-aurora-config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 file opencc zstd python3-pyelftools python3-setuptools

      - name: Download and Setup SDK
        run: |
          SDK_LINK="${{ github.event.inputs.sdk_url }}"
          [ -z "$SDK_LINK" ] && SDK_LINK="$DEFAULT_SDK_URL"
          
          echo "Downloading SDK from: $SDK_LINK"
          wget -q "$SDK_LINK" -O sdk.archive
          
          mkdir sdk
          if file sdk.archive | grep -q 'Zstandard'; then
            tar -I zstd -xf sdk.archive -C sdk --strip-components=1
          else
            tar -xf sdk.archive -C sdk --strip-components=1
          fi
          
          SDK_FILE=$(basename "$SDK_LINK")
          if [[ "$SDK_FILE" =~ openwrt-sdk-([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VER="${BASH_REMATCH[1]}"
          else
            VER="snapshot"
          fi
          echo "OPENWRT_VERSION=$VER" >> $GITHUB_ENV
          
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clone, Fix Dependencies & Translate
        working-directory: ./sdk/package
        run: |
          git clone $PKG_URL $PKG_NAME
          
          # === 關鍵修復：移除遞迴依賴 ===
          echo "正在修復 Makefile 中的遞迴依賴..."
          # 移除 +rpcd (不管是位於行中或行尾)
          sed -i 's/+rpcd //g' $PKG_NAME/Makefile
          sed -i 's/+rpcd//g' $PKG_NAME/Makefile
          
          cd $PKG_NAME/po
          
          echo "=== 步驟 1: 處理簡體中文 (Base) ==="
          if [ -d "zh-cn" ]; then
            mv zh-cn zh_Hans
            sed -i 's/Language: zh_CN/Language: zh_Hans/g' zh_Hans/*.po
            sed -i 's/"Language-Team: zh_CN/"Language-Team: zh_Hans/g' zh_Hans/*.po
          fi
          
          echo "=== 步驟 2: 建立繁體中文 (New) ==="
          if [ -d "zh_Hans" ]; then
            cp -r zh_Hans zh_Hant
            for file in zh_Hant/*.po; do
              opencc -c s2tw.json -i "$file" -o "$file.tmp"
              mv "$file.tmp" "$file"
              sed -i 's/Language: zh_Hans/Language: zh_Hant/g' "$file"
              sed -i 's/Language: zh_CN/Language: zh_Hant/g' "$file"
              sed -i 's/"Language-Team: zh_Hans/"Language-Team: zh_Hant/g' "$file"
            done
          fi

      - name: Configure Build
        working-directory: ./sdk
        run: |
          make defconfig
          
          # 關閉 u-boot 避免不必要的錯誤
          sed -i 's/CONFIG_PACKAGE_uboot-rockchip.*=y/# CONFIG_PACKAGE_uboot-rockchip is not set/' .config
          sed -i 's/CONFIG_PACKAGE_uboot-rockchip.*=m/# CONFIG_PACKAGE_uboot-rockchip is not set/' .config

          # 設定插件
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hant=y" >> .config
          echo "CONFIG_PACKAGE_$PKG_NAME=m" >> .config
          
          make defconfig
          
          # 暴力開啟語言包
          sed -i "s/# CONFIG_PACKAGE_luci-i18n-${PKG_NAME#luci-app-}-\(.*\) is not set/CONFIG_PACKAGE_luci-i18n-${PKG_NAME#luci-app-}-\1=m/g" .config
          
          make defconfig
          
          # 檢查依賴修復是否生效 (不應再出現 recursive dependency error)
          echo "=== Build Config Check ==="
          grep "CONFIG_PACKAGE_$PKG_NAME" .config

      - name: Compile Package
        working-directory: ./sdk
        run: |
          echo "=== Start Compiling $PKG_NAME ==="
          # 使用 IGNORE_ERRORS=1 忽略非致命錯誤 (如 po 格式警告)
          make package/$PKG_NAME/compile V=s -j$(nproc) IGNORE_ERRORS=1 || \
          make package/$PKG_NAME/compile V=s -j1 IGNORE_ERRORS=1

      - name: Organize Files
        run: |
          mkdir -p bin-output
          # 支援 ipk (舊版) 和 apk (新版)
          find sdk/bin/ -type f \( -name "${PKG_NAME}*.*pk" -o -name "luci-i18n-${PKG_NAME#luci-app-}*.*pk" \) -exec cp -v {} bin-output/ \;
          ls -R bin-output/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-${{ env.OPENWRT_VERSION }}-zh-tw
          path: bin-output/
          if-no-files-found: error
